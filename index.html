<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Connection Cost Planner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: 'Courier New', monospace;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            margin-top: 10px;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .error-msg, .success-msg, .warning-msg {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-msg {
            background: #ff6b6b;
            color: white;
        }

        .success-msg {
            background: #51cf66;
            color: white;
        }

        .warning-msg {
            background: #ffd43b;
            color: #333;
        }

        .error-msg.active, .success-msg.active, .warning-msg.active {
            display: block;
        }

        .cost-display {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .cost-display h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .cost-display .cost {
            font-size: 3em;
            font-weight: bold;
        }

        .cost-display .algorithm {
            font-size: 0.9em;
            margin-top: 10px;
            opacity: 0.8;
        }

        .route-path {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .route-path h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .path-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .city-node {
            background: #667eea;
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .city-node.start {
            background: #11998e;
        }

        .city-node.end {
            background: #764ba2;
        }

        .arrow {
            color: #667eea;
            font-size: 1.5em;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .matrix-grid {
            overflow-x: auto;
            margin-top: 15px;
        }

        .matrix-table {
            border-collapse: collapse;
            margin: 0 auto;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: center;
            min-width: 80px;
        }

        .matrix-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .matrix-table td input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .step-indicator {
            text-align: center;
            margin-bottom: 30px;
        }

        .step {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #666;
            line-height: 40px;
            margin: 0 10px;
            font-weight: 600;
        }

        .step.active {
            background: #667eea;
            color: white;
        }

        .step.completed {
            background: #51cf66;
            color: white;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .path-container {
                flex-direction: column;
            }

            .arrow {
                transform: rotate(90deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>✈️ Flight Connection Cost Planner</h1>
            <p>Find the cheapest flight routes using Dijkstra, Bellman-Ford & Floyd-Warshall algorithms</p>
        </div>

        <!-- Step 1: Database Configuration -->
        <div class="card" id="step1">
            <h2>Step 1: Database Configuration</h2>
            <div class="form-group">
                <label>Supabase URL</label>
                <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
            </div>
            <div class="form-group">
                <label>Supabase API Key (anon/public)</label>
                <input type="password" id="supabaseKey" placeholder="Your anon key">
            </div>
            <button class="btn" onclick="connectDatabase()">Connect to Database</button>
            <div class="success-msg" id="dbSuccess"></div>
            <div class="error-msg" id="dbError"></div>
        </div>

        <!-- Step 2: City & Graph Setup -->
        <div class="card hidden" id="step2">
            <h2>Step 2: Setup Cities & Flight Costs</h2>
            
            <div class="form-group">
                <label>Number of Cities</label>
                <input type="number" id="numCities" min="2" max="10" value="3" placeholder="Enter number of cities (2-10)">
            </div>

            <div class="form-group">
                <label>City Names (comma-separated)</label>
                <input type="text" id="cityNames" placeholder="Mumbai, Delhi, Bangalore">
                <small style="color: #666; display: block; margin-top: 5px;">Example: Mumbai, Delhi, Bangalore, Chennai</small>
            </div>

            <button class="btn btn-success" onclick="generateMatrix()">Generate Cost Matrix</button>
            
            <div id="matrixSection" class="hidden" style="margin-top: 30px;">
                <h3 style="color: #333; margin-bottom: 15px;">Enter Flight Costs (use 99999 for no direct flight)</h3>
                <div class="matrix-grid" id="matrixContainer"></div>
                <button class="btn" onclick="saveGraph()" style="margin-top: 20px;">Save Graph & Proceed</button>
            </div>

            <div class="error-msg" id="graphError"></div>
        </div>

        <!-- Step 3: Calculate Routes -->
        <div class="card hidden" id="step3">
            <h2>Step 3: Calculate Shortest Routes</h2>
            
            <div class="warning-msg" id="negativeEdgeWarning" style="display: none;">
                ⚠️ Graph contains negative edges. Dijkstra algorithm is not applicable!
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Algorithm</label>
                    <select id="algorithm">
                        <option value="dijkstra">Dijkstra (Positive weights only)</option>
                        <option value="bellman-ford">Bellman-Ford (Handles negative weights)</option>
                        <option value="floyd-warshall">Floyd-Warshall (All-pairs shortest path)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Source City</label>
                    <select id="sourceCity"></select>
                </div>
            </div>

            <button class="btn" onclick="calculateRoute()">Calculate & Store Results</button>
            <button class="btn btn-secondary" onclick="viewStoredResults()">View All Database Records</button>
            
            <div class="error-msg" id="calcError"></div>
            <div class="success-msg" id="calcSuccess"></div>
        </div>

        <!-- Results Display -->
        <div class="card hidden" id="resultsCard">
            <div class="cost-display">
                <h3>Shortest Distances from <span id="resultSource"></span></h3>
                <div class="algorithm" id="resultAlgorithm"></div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Destination City</th>
                            <th>Cost</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Database Records -->
        <div class="card hidden" id="databaseCard">
            <h2>Stored Database Records</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Source</th>
                            <th>Destination</th>
                            <th>Cost</th>
                            <th>Algorithm</th>
                        </tr>
                    </thead>
                    <tbody id="databaseTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabaseClient = null;
        let n = 0;
        let graph = [];
        let city = [];
        const INF = 99999;

        async function connectDatabase() {
            const url = document.getElementById('supabaseUrl').value.trim();
            const key = document.getElementById('supabaseKey').value.trim();
            
            const errorDiv = document.getElementById('dbError');
            const successDiv = document.getElementById('dbSuccess');
            
            errorDiv.classList.remove('active');
            successDiv.classList.remove('active');

            if (!url || !key) {
                errorDiv.textContent = 'Please enter both Supabase URL and API Key';
                errorDiv.classList.add('active');
                return;
            }

            try {
                supabaseClient = supabase.createClient(url, key);
                
                const { data, error } = await supabaseClient.from('routes').select('id').limit(1);
                
                if (error) throw error;

                successDiv.textContent = '✓ Successfully connected to database!';
                successDiv.classList.add('active');
                
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                
            } catch (error) {
                errorDiv.textContent = 'Connection failed: ' + error.message;
                errorDiv.classList.add('active');
            }
        }

        function generateMatrix() {
            const numCities = parseInt(document.getElementById('numCities').value);
            const cityNamesInput = document.getElementById('cityNames').value.trim();
            const errorDiv = document.getElementById('graphError');
            
            errorDiv.classList.remove('active');

            if (!numCities || numCities < 2 || numCities > 10) {
                errorDiv.textContent = 'Please enter a valid number of cities (2-10)';
                errorDiv.classList.add('active');
                return;
            }

            if (!cityNamesInput) {
                errorDiv.textContent = 'Please enter city names';
                errorDiv.classList.add('active');
                return;
            }

            city = cityNamesInput.split(',').map(c => c.trim()).filter(c => c);
            
            if (city.length !== numCities) {
                errorDiv.textContent = `Please enter exactly ${numCities} city names`;
                errorDiv.classList.add('active');
                return;
            }

            n = numCities;
            
            // Generate matrix input table
            let html = '<table class="matrix-table"><thead><tr><th></th>';
            city.forEach(c => {
                html += `<th>${c}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (let i = 0; i < n; i++) {
                html += `<tr><th>${city[i]}</th>`;
                for (let j = 0; j < n; j++) {
                    const value = i === j ? 0 : '';
                    const disabled = i === j ? 'disabled' : '';
                    html += `<td><input type="text" id="cell_${i}_${j}" value="${value}" ${disabled} placeholder="Cost"></td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table>';
            html += '<p style="margin-top: 15px; color: #666; text-align: center;">Enter flight costs. Use 99999 or INF for no direct flight. Diagonal cells are auto-set to 0.</p>';

            document.getElementById('matrixContainer').innerHTML = html;
            document.getElementById('matrixSection').classList.remove('hidden');
        }

        function saveGraph() {
            const errorDiv = document.getElementById('graphError');
            errorDiv.classList.remove('active');

            graph = [];
            for (let i = 0; i < n; i++) {
                graph[i] = [];
                for (let j = 0; j < n; j++) {
                    const input = document.getElementById(`cell_${i}_${j}`);
                    if (!input) continue;
                    
                    const val = input.value.trim();
                    if (val.toUpperCase() === 'INF' || val === '') {
                        graph[i][j] = INF;
                    } else {
                        const num = parseFloat(val);
                        graph[i][j] = isNaN(num) ? INF : num;
                    }
                }
            }

            // Check for negative edges
            const hasNegEdge = hasNegativeEdge();
            if (hasNegEdge) {
                document.getElementById('negativeEdgeWarning').style.display = 'block';
            }

            // Populate source city dropdown
            const sourceSelect = document.getElementById('sourceCity');
            sourceSelect.innerHTML = '';
            city.forEach(c => {
                sourceSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });

            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');
        }

        function hasNegativeEdge() {
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    if (graph[i][j] !== INF && graph[i][j] < 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function dijkstra(src) {
            const dist = new Array(n).fill(INF);
            const visited = new Array(n).fill(false);
            dist[src] = 0;

            for (let iter = 0; iter < n; iter++) {
                let u = -1;
                let best = INF + 1;
                for (let i = 0; i < n; i++) {
                    if (!visited[i] && dist[i] < best) {
                        best = dist[i];
                        u = i;
                    }
                }
                if (u === -1) break;
                visited[u] = true;

                for (let v = 0; v < n; v++) {
                    const w = (typeof graph[u][v] === 'number') ? graph[u][v] : INF;
                    if (!visited[v] && w !== INF) {
                        const alt = dist[u] + w;
                        if (alt < dist[v]) dist[v] = alt;
                    }
                }
            }

            return dist;
        }

        function bellmanFord(src) {
            const dist = new Array(n).fill(INF);
            dist[src] = 0;

            for (let iter = 0; iter < n - 1; iter++) {
                let changed = false;
                for (let u = 0; u < n; u++) {
                    if (dist[u] === INF) continue;
                    for (let v = 0; v < n; v++) {
                        const w = (typeof graph[u][v] === 'number') ? graph[u][v] : INF;
                        if (w !== INF) {
                            const alt = dist[u] + w;
                            if (alt < dist[v]) {
                                dist[v] = alt;
                                changed = true;
                            }
                        }
                    }
                }
                if (!changed) break;
            }

            // Negative cycle check
            let negativeCycle = false;
            for (let u = 0; u < n; u++) {
                if (dist[u] === INF) continue;
                for (let v = 0; v < n; v++) {
                    const w = (typeof graph[u][v] === 'number') ? graph[u][v] : INF;
                    if (w !== INF && dist[u] + w < dist[v]) {
                        negativeCycle = true;
                        break;
                    }
                }
                if (negativeCycle) break;
            }

            return { dist, negativeCycle };
        }

        function floydWarshall() {
            const dist = Array.from({ length: n }, (_, i) => 
                Array.from({ length: n }, (_, j) => {
                    const v = graph[i][j];
                    return (typeof v === 'number') ? v : INF;
                })
            );

            for (let i = 0; i < n; i++) dist[i][i] = Math.min(dist[i][i], 0);

            for (let k = 0; k < n; k++)
                for (let i = 0; i < n; i++)
                    for (let j = 0; j < n; j++)
                        if (dist[i][k] !== INF && dist[k][j] !== INF && 
                            dist[i][k] + dist[k][j] < dist[i][j])
                            dist[i][j] = dist[i][k] + dist[k][j];

            return dist;
        }

        async function calculateRoute() {
            const algorithm = document.getElementById('algorithm').value;
            const sourceName = document.getElementById('sourceCity').value;
            const errorDiv = document.getElementById('calcError');
            const successDiv = document.getElementById('calcSuccess');
            
            errorDiv.classList.remove('active');
            successDiv.classList.remove('active');

            const srcIdx = city.indexOf(sourceName);
            if (srcIdx === -1) {
                errorDiv.textContent = 'City not found!';
                errorDiv.classList.add('active');
                return;
            }

            let dist;
            let algorithmName;

            if (algorithm === 'dijkstra') {
                if (hasNegativeEdge()) {
                    errorDiv.textContent = 'Graph has negative edges. Dijkstra is not applicable!';
                    errorDiv.classList.add('active');
                    return;
                }
                dist = dijkstra(srcIdx);
                algorithmName = 'Dijkstra';
            } else if (algorithm === 'bellman-ford') {
                const result = bellmanFord(srcIdx);
                if (result.negativeCycle) {
                    errorDiv.textContent = 'Negative-weight cycle detected!';
                    errorDiv.classList.add('active');
                    return;
                }
                dist = result.dist;
                algorithmName = 'Bellman-Ford';
            } else if (algorithm === 'floyd-warshall') {
                const allDist = floydWarshall();
                dist = allDist[srcIdx];
                algorithmName = 'Floyd-Warshall';
            }

            // Display results
            displayResults(sourceName, dist, algorithmName);

            // Store in database
            const rowsToInsert = [];
            for (let v = 0; v < n; v++) {
                if (dist[v] !== INF) {
                    rowsToInsert.push({
                        source: city[srcIdx],
                        destination: city[v],
                        cost: dist[v],
                        algorithm_used: algorithmName
                    });
                }
            }

            if (rowsToInsert.length === 0) {
                errorDiv.textContent = 'No reachable destinations to store.';
                errorDiv.classList.add('active');
            } else {
                try {
                    const { data: insertData, error: insertErr } = await supabaseClient
                        .from('routes')
                        .insert(rowsToInsert)
                        .select();
                    
                    if (insertErr) {
                        errorDiv.textContent = 'Insert error: ' + insertErr.message;
                        errorDiv.classList.add('active');
                    } else {
                        successDiv.textContent = `✓ Stored ${insertData.length} result(s) in database successfully!`;
                        successDiv.classList.add('active');
                    }
                } catch (err) {
                    errorDiv.textContent = 'Insert failed: ' + err.message;
                    errorDiv.classList.add('active');
                }
            }
        }

        function displayResults(source, dist, algorithm) {
            document.getElementById('resultSource').textContent = source;
            document.getElementById('resultAlgorithm').textContent = `Algorithm: ${algorithm}`;

            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            for (let i = 0; i < n; i++) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${city[i]}</strong></td>
                    <td>${dist[i] === INF ? 'N/A' : '₹' + dist[i].toLocaleString()}</td>
                    <td>${dist[i] === INF ? 'No Path' : 'Reachable'}</td>
                `;
                tbody.appendChild(tr);
            }

            document.getElementById('resultsCard').classList.remove('hidden');
        }

        async function viewStoredResults() {
            try {
                const { data, error } = await supabaseClient
                    .from('routes')
                    .select('*')
                    .order('id', { ascending: true });

                if (error) throw error;

                const tbody = document.getElementById('databaseTableBody');
                tbody.innerHTML = '';

                if (!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No records found</td></tr>';
                } else {
                    data.forEach(row => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${row.id}</td>
                            <td>${row.source || '-'}</td>
                            <td>${row.destination || '-'}</td>
                            <td>₹${row.cost ? row.cost.toLocaleString() : '0'}</td>
                            <td>${row.algorithm_used || '-'}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }

                document.getElementById('databaseCard').classList.remove('hidden');

            } catch (error) {
                alert('Error loading stored results: ' + error.message);
            }
        }
    </script>
</body>
</html>